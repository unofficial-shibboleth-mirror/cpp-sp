<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
    <meta name="generator" content=
    "HTML Tidy for Mac OS X (vers 1st January 2002), see www.w3.org">

    <title>Shibboleth Origin Deployment Guide</title>
    <meta http-equiv="Content-Type" content=
    "text/html; charset=utf-8">
    <style type="text/css">

html
{	
background-color: #FFFFFF;
color: #000000;
margin: .5em;
}
a:visited
{
color: #999999;
}
a:link
{
color: #990000;
}
a:active
{
color: #440000;
}
dl
{
background-color: #DDDDDD;
background-image: none;
margin: 5px;
padding: 0px;
border-style: solid;
border-bottom-width: 2px;
border-top-width: 2px;
border-left-width: 2px;
border-right-width: 2px;
}
dt
{
background-color: #DDDDDD;
background-image: none;
margin: 1px;
padding: 1px;
}
dd
{
background-color: #DDDDDD;
background-image: none;
margin: 0px;
padding: 1px;
}
.attribute
{
font-size: 115%;
font-color: #000000;
text-align: left;
background-color: #DDDDDD;
border: 1px black inset;
background-image: none;
margin: 0px;
padding: 2px;
}
.value
{
font-color: #000000;
text-align: left;
background-color: #EEEEEE;
background-image: none;
padding-top: 0em;
padding-bottom: 0.5em;
padding-right: 1em;
padding-left: 5em;
border-style: solid;
border-bottom-width: none;
border-top-width: none;
border-left-width: 1px;
border-right-width: 1px;
}
.attributeopt
{
font-size: 115%;
font-color: #000000;
text-align: left;
background-color: #BCBCEE;
border: 1px black inset;
background-image: none;
margin: 0px;
padding: 2px;
}
.valueopt
{
font-color: #000000;
text-align: left;
background-color: #DDDDFF;
background-image: none;
padding-top: 0em;
padding-bottom: 0.5em;
padding-right: 1em;
padding-left: 5em;
border-style: solid;
border-bottom-width: none;
border-top-width: none;
border-left-width: 1px;
border-right-width: 1px;
}
.attributelong
{
font-size: 85%;
font-color: #000000;
text-align: left;
background-color: #DDDDDD;
border: 1px black inset;
background-image: none;
margin: 0px;
padding: 2px;
}
.attributeoptlong
{
font-size: 85%;
font-color: #000000;
text-align: left;
background-color: #BCBCEE;
border: 1px black inset;
background-image: none;
margin: 0px;
padding: 2px;
}
.demo
{
background-color: #EEEEEE;
padding: 3px;
}
.fixed
{
font-family: monospace;
font-size: 90%;
font-color: #121212;
}
.feature
{
color: #00FF00
}

  </style>
  </head>

  <body link="red" vlink="red" alink="black" bgcolor="white">
    <center>
      <h2>Shibboleth Origin Deployment Guide</h2>
    </center>
	Shibboleth Origin Deployment Guide<br>
	Shibboleth Version 1.0.1<br />
	July 25, 2003<br />
     
	<h3>This version of the deploy guide is for Shibboleth v1.0.1. For documentation 
	related to prior versions of Shibboleth, please consult the appropriate branch 
	in the Shibboleth CVS.</h3>

    <h3>Federations have been abstracted out from the Shibboleth
    documentation.  For further information on using Shibboleth in a
    federation, refer to the federation guide.</h3>

	<p>Shibboleth v1.0.1 is stable and secure enough to deploy in production 
	scenarios. It is backward compatible with 1.0 in all respects, including 
	configuration, but some older commands have been deprecated or replaced.</p>
	
	<p>Features and changes specific to 1.0.1 are marked with <span class="feature">
	[1.0.1]</span></p>
	
	<h4>Major New Features in 1.0 and 1.0.1</h4>
	This new release contains many improvements and enhancements, including: 
	
	<h5>Federation Support</h5>
	<ol>
	    <li>Federation and trust support has been substantially extended. Federation 
	    structures are now defined. The set of metadata collected and managed by 
	    each Federation is more fully defined. The configuration values assigned by 
	    a Federation are now identified. </li>
	    <li>There is some support for targets to be members of multiple federations; 
	    this support will continue to evolve. When a browser user arrives, a target 
	    will determine which federation their origin belongs to, and then use the 
	    trust fabric associated with that Federation.</li>
	    <li>Better support for flexible and bilateral trust agreements. A key 
	    specific to an origin site can be used to vallidate its signature.</li>
	    <li>This version contains a significantly more mature security 
	    implementation, and should meet the security requirements of typical sites.</li>
	</ol>
	<h5>Origin</h5>
	<ol>
	    <li>The Attribute Authority has a powerful new attribute resolver. Simple 
	    scenarios (using a string attribute stored in ldap) can be accomplished by 
	    merely editing a configuration file. Java classes may still be written for 
	    more complex evaluations (eg retrieving information from multiple disparate 
	    repositories, and computing the SAML attribute using business rules). This 
	    should greatly simplify the process of configuring the AA to support 
	    additional general attributes.</li>
	    <li>Support for a runtime-derived per-requester persistent identifier 
	    attribute to support anonymous personalization by targets has been added via 
	    an attribute plugin. <span class="feature">[1.0.1]</span></li>
	    <li>Specialized deployments without privacy needs can configure identity-based 
	    handles interoperable with other SAML deployments. <span class="feature">
	    [1.0.1]</span></li>
	</ol>
	<h5>Target</h5>
	<ol>
	    <li>Significantly more flexibility in configuring targets to ensure 
	    robustness. Failover and redundant configurations are now supported.</li>
	    <li>The SHAR may now optionally store its session and attribute cache in a 
	    back-end database in addition to the previously available in-memory option. 
	    This would allow a site to run an apache server farm, with multiple SHARs, 
	    supporting the same set of sessions.</li>
	    <li>Federation supplied files (sites.xml and trust.xml) are now refreshed in 
	    a much more robust manner.</li>
	    <li>The SHAR can be configured to request specific attributes from the 
	    Origin.</li>
	    <li>The SHAR can use TCP sockets when responding to the Apache module, for 
	    specialized deployment behind firewalls. <span class="feature">[1.0.1]</span>
	    </li>
	    <li>Attribute acceptance policies have been greatly enhanced, and are now 
	    used to configure all aspects of attribute handling by the target, except 
	    for requesting specific attributes by sitename. Adding attributes now takes 
	    place in one configuration step. <span class="feature">[1.0.1]</span> </li>
	    <li>Support for Apache 1.3 on Windows NT/2000/XP/2003 has been added.
	    <span class="feature">[1.0.1]</span></li>
	    <li>Microsoft IIS web server support has been added via an ISAPI filter and 
	    extension. <span class="feature">[1.0.1]</span></li>
	</ol>
	<h5>Miscellaneous</h5>
	<ol>
	    <li>Origin sites can configure a value to describe the type of 
	    authentication mechanism used at the origin site(e.g. password, Kerberos, 
	    PKI, etc.). This value is made available on the target side as Shib-Authentication-Method.</li>
	    <li>Various improvements to error handling. Origin sites are now able to 
	    supply an error URL and contact information to a federation. When a target 
	    encounters an error, it can include this information in the error page.</li>
	    <li>Local time string values are now used in log files.</li>
	    <li>Internationalization support has been extended.</li>
	</ol>

    <p>Before starting, please sign up for all applicable <a href=
    "http://shibboleth.internet2.edu/shib-misc.html#mailinglist">
    mailing lists</a>. Announcements pertinent to Shibboleth
    deployments and developments and resources for deployment
    assistance can be found here.</p>

    <p>Please send any questions, concerns, or eventual confusion
    to <a href="mailto:mace-shib-users@internet2.edu">mace-shib-users@internet2.edu</a>.
    This should include, but not be limited to, questions about the
    documentation, undocumented problems, installation or
    operational issues, and anything else that arises. Please
    ensure that you have the <a href=
    "http://shibboleth.internet2.edu/release/shib-download.html">appropriate
    .tarball</a> for your operating system.</p>
    <br>
    <hr>
    <br>
    <br>
     

    <h3><a name="TOC"></a>Shibboleth Origin -- Table of Contents</h3>
    <br>
     

    <ol type="1">
      <li>
        <h4><a href="#1."><font color="black">Shibboleth
        Overview</font></a></h4>

        <ol type="a">
          <li><a href="#1.a."><font color=
          "black">Origin</font></a></li>

          <li><a href="#1.b."><font color=
          "black">Target</font></a></li>

          <li><a href="#1.c."><font color=
          "black">WAYF</font></a></li>

          <li><a href="#1.d."><font color=
          "black">Federations</font></a></li>
        </ol>
      </li>

      <li>
        <h4><a href="#2."><font color=
        "black">Planning</font></a></h4>

        <ol type="a">
          <li><a href="#2.a."><font color=
          "black">Requirements</font></a></li>

          <li><a href="#2.b."><font color="black">Join a
          Federation</font></a></li>

          <li><a href="#2.c."><font color="black">Security
          Considerations</font></a></li>

          <li><a href="#2.d."><font color="black">Server
          Certs</font></a></li>

          <li><a href="#2.e."><font color="black">Attribute Release
          Policies</font></a></li>

          <li><a href="#2.f."><font color="black">Designate
          Contacts</font></a></li>

          <li><a href="#2.g."><font color="black">Browser
          Requirements</font></a></li>

          <li><a href="#2.h."><font color=
          "black">Clocks</font></a></li>

          <li><a href="#2.i."><font color="black">Other
          Considerations</font></a></li>
        </ol>
      </li>

      <li>
        <h4><a href="#3."><font color=
        "black">Installation</font></a></h4>

        <ol type="a">
          <li><a href="#3.a."><font color="black">Software
          Requirements</font></a></li>

          <li><a href="#3.b."><font color="black">Deploy HS and
          AA</font></a></li>

        </ol>
      </li>

      <li>
        <h4><a href="#4."><font color="black">Getting
        Running</font></a></h4>

        <ol type="a">
          <li><a href="#4.a."><font color="black">Basic
          Configuration</font></a></li>

          <li>
            <a href="#4.b."><font color="black">Key Generation and
            Certificate Installation</font></a> 

          </li>

          <li><a href="#4.c."><font color="black">Linking the
          Authentication System to the HS</font></a>
          
            <ol type="i">
              <li><a href="#4.c.i."><font color="black">Enabling client
              certificate authentication</font> <font color="#5555EE">(optional)</font></a></li>
            </ol>
          </li>

          <li><a href="#4.d."><font color="black">Establishing
          default ARP's for the origin community</font></a></li>

  		  <li><a href="#4.e."><font color="black">Modifying the 
		  default Attribute Resolver configuration</font></a></li>

        </ol>
      </li>

      <li>
        <h4><a href="#5."><font color="black">Advanced
        Configuration</font></a></h4>

        <ol type="a">
          <li>
            <a href="#5.a."><font color="black">ARP
            Overview</font></a> 

            <ol type="i">
              <li><a href="#5.a.i."><font color="black">ARP
              Processing</font></a></li>

              <li><a href="#5.a.ii."><font color="black">ARP
              Syntax</font></a></li>
            </ol>
              <li><a href="#5.b."><font color="black">Sharing
              certificate/key pairs between Apache and Java
              keystores</font> <font color="#5555EE">(optional)</font></a></li>
          <li><a href="#5.c."><font color="black">The Attribute Resolver</font></a></li>
          <li><a href="#5.d."><font color="black">Local Error Page</font></a></li>
        </ol>
      </li>

      <li>
        <h4><a href="#6."><font color=
        "black">Troubleshooting</font></a></h4>

        <ol type="a">
          <li><a href="#6.a."><font color="black">Basic
          Testing</font></a></li>

          <li><a href="#6.b."><font color=
          "black">Logging</font></a></li>

          <li><a href="#6.c."><font color="black">Common
          Problems</font></a></li>
        </ol>
      </li>
    </ol>
    <br>
    <hr>
    <br>
     

    <h3><a name="1."></a>1. Shibboleth Overview</h3>

    <p>Shibboleth is a system designed to exchange attributes
    across realms for the primary purpose of authorization. It
    provides a secure framework for one organization to transmit
    attributes about a web-browsing individual across security
    domains to another institution. In the primary usage case, when
    a user attempts to access a resource at a remote domain, the
    user's own home security domain can send certain information
    about that user to the target site in a trusted exchange. These
    attributes can then be used by the resource to help determine
    whether to grant the user access to the resource. The user may
    have the ability to decide whether to release specific
    attributes to certain sites by specifying personal Attribute
    Release Policies (ARP's), effectively preserving privacy while
    still granting access based on trusted information.</p>

    <p>When a user first tries to access a resource protected by
    Shibboleth, they are redirected to a service which asks the
    user to specify the organization from which they want to
    authenticate. If the user has not yet locally authenticated to
    a WebISO service, the user will then be redirected to their
    home institution's authentication system. After the user
    authenticates, the Shibboleth components at the local
    institution will generate a temporary reference to the user,
    known as a handle, for the individual and send this to the
    target site. The target site can then use the handle to ask for
    attributes about this individual. Based on these attributes,
    the target can decide whether or not to grant access to the
    resource. The user may then be allowed to access the requested
    materials.</p>

    <p>There are several controls on privacy in Shibboleth, and
    mechanisms are provided to allow users to determine exactly
    which information about them is released. A user's actual
    identity isn't necessary for many access control decisions, so
    privacy often is needlessly compromised. Instead, the resource
    often utilizes other attributes such as faculty member or member
    of a certain class. While these are commonly determined using
    the identity of the user, Shibboleth provides a way to mutually
    refer to the same principal without revealing that principal's
    identity. Because the user is initially known to the target site
    only by a randomly generated temporary handle, if sufficient,
    the target site might know no more about the user than that the
    user is a member of the origin organization. This handle should
    never be used to decide whether or not to grant access, and is
    intended only as a temporary reference for requesting
    attributes.</p>

    <h4><a name="1.a."></a>1.a. Origin</h4>

    <blockquote>
      <p>There are four primary components to the origin side in
      Shibboleth: the Attribute Authority (AA), the Handle Service
      (HS), the directory service, and the local sign-on system
      (SSO). The AA and HS are provided with Shibboleth, and an
      open-source WebISO solution, Pubcookie, can be obtained from
      www.pubcookie.org; the directory is provided by the origin
      site. Shibboleth is able to interface with a directory
      exporting an LDAP interface containing user attributes, and is
      designed such that programming interfaces to other
      repositories should be readily implemented. Shibboleth relies
      on standard web server mechanisms to trigger local
      authentication. A .htaccess file can be easily used to trigger
      either the local WebISO system or the web server's own Basic
      Auth mechanism, which will likely utilize an enterprise
      authentication system, such as Kerberos.</p>

      <p>From the origin site's point of view, the first contact
      will be the redirection of a user to the handle service,
      which will then consult the SSO system to determine whether
      the user has already been authenticated. If not, then the
      browser user will be asked to authenticate, and then sent
      back to the target URL with a handle bundled in an attribute
      assertion. Next, a request from the Shibboleth Attribute
      Requester (SHAR) will arrive at the AA which will include the
      previously mentioned handle. The AA then consults the ARP's
      for the directory entry corresponding to the handle, queries
      the directory for these attributes, and releases to the SHAR
      all attributes the SHAR is entitled to know about that
      user.</p>
    </blockquote>

    <h4><a name="1.b."></a>1.b. Target</h4>

    <blockquote>
      <p>There are three primary components to the target side in
      Shibboleth: the Shibboleth Indexical Reference Establisher
      (SHIRE), the Shibboleth Attribute Requester (SHAR), and the
      resource manager (RM). An implementation of each of these is
      included in the standard Shibboleth distribution. These
      components are intended to run on the same web server.</p>

      <p>From the target's point of view, a browser will hit the RM
      with a request for a Shibboleth-protected resource. The RM
      then allows the SHIRE to step in, which will use the WAYF to
      acquire the name of a handle service to ask about the user.
      The handle service (HS) will then reply with a SAML
      authentication assertion containing a handle, which the SHIRE
      then hands off to the SHAR. The SHAR uses the handle and the
      supplied address of the corresponding attribute authority
      (AA) to request all attributes it is allowed to know about
      the handle. The SHAR performs some basic validation and
      analysis based on attribute acceptance policies (AAP's).
      These attributes are then handed off to the RM, which is
      responsible for using these attributes to decide whether to
      grant access.</p>
    </blockquote>

    <h4><a name="1.c."></a>1.c. Where are you from? (WAYF)</h4>

    <blockquote>
      <p>The WAYF service can be either outsourced and operated by
      a federation or deployed as part of the SHIRE. It is responsible
      for allowing a user to associate themself with an institution
      of their specification, then redirecting the user to the
      known address for the handle service of that institution.</p>
    </blockquote>

    <h4><a name="1.d."></a>1.d. Federations</h4>

    <blockquote>
      <p>A Shibboleth federation provides part of the underlying trust
      required for function of the Shibboleth architecture. A federation
      is a group of organizations(universities, corporations,
      content providers, etc.) who agree to exchange attributes
      using the SAML/Shibboleth protocols and abide by a common set
      of policies and practices. In so doing, they must implicitly
      or explicitly agree to a common set of guidelines. Joining a
      federation is not explicitly necessary for operation of Shibboleth,
      but it dramatically expands the number of targets and origins
      that can interact without defining bilateral agreements
      between all these parties.</p>

      <p>A federation can be created in a variety of formats and trust
      models, but must provide a certain set of services to federation
      members. It needs to supply a registry to process
      applications to the federation and distribute membership
      information to the origin and target sites. This must include
      distribution of the PKI components necessary for trust
      between origins and targets. There also needs to be a set of
      agreements and best practices defined by the federation governing
      the exchange, use, and population of attributes before and
      after transit, and there should be a way to find information
      on local authentication and authorization practices for federation
      members.</p>
    </blockquote>
    <br>
    <br>
    <br>
    <hr>
    <br>
     

    <h3><a name="2."></a>2. Planning</h3>

    <p>There are several essential elements that must be present in
    the environment to ensure Shibboleth functions well, both
    political and technical. Shibboleth is entirely written in
    Java on the origin side. These are the recommendations and
    requirements for a successful implementation of a Shibboleth
    origin.</p>

    <h4><a name="2.a."></a>2.a. Requirements</h4>

    <ul>
      <li>
        <p>A common institutional directory service should be
        operational; Shibboleth comes with LDAP capabilities
        built in, and the Attribute Authority has a Java API which
        will allow specification of interfaces with legacy
        directories. This is discussed further in <a href=
        "#4.d.">section 4.d</a>.</p>
      </li>

      <li>
        <p>A method to authenticate browser users must be in place,
        preferably in the form of an enterprise authentication
        service. Some form of an SSO or a WebISO service is not
        explicitly necessary for Shibboleth; however, it is highly
        recommended. Implementation details of this are discussed in
        <a href="#4.c.">section 4.c</a>.</p>
      </li>

      <li>
        <p>Shibboleth is known to work on Linux and Solaris, but
        should function on any platform that has a Tomcat
        implementation.</p>
      </li>

      <li>
        <p>It is recommended that a web server must be deployed that
        can host Java servlets and Tomcat, although not explicitly
        necessary, as Tomcat can still host an origin without it.</p>
      </li>
    </ul>

    <h4><a name="2.b."></a>2.b. Join a Federation</h4>

    <blockquote>
      <p>While it is not necessary for a target or origin to join a
      federation, doing so greatly facilitates the implementation of
      multilateral trust relationships. Each federation will have a
      different application process. When an origin is accepted into a
      federation, its information is added to the sites file used by the
      WAYF and target sites.</p>
      
      <p><b>It may be necessary to join multiple federations
      depending on the sites with whom you wish to exchange
      attributes and the terms under which these interactions will
      take place.  An origin site exists within the context of a
      single federation, while a single target may accept assertions
      issued by multiple federations if they are all recognized by
      the SHAR.  If an organization wishes to be a member of
      multiple federations, it must run a separate origin site for
      each federation, including a separate AA and HS.</b></p>

      <p>Attribute release and acceptance policies, the use and
      caching of attributes, and definition of commonly traded
      attributes are examples of specifications a federation may
      make.  For more information on federations, please refer to
      the Deployer's Guide to Federations and the Shibboleth v1.0
      architectural document.</p>
    </blockquote>

    <h4><a name="2.c."></a>2.c. Security Considerations</h4>

    <blockquote>
      <p>Shibboleth's protocols and software have been extensively
      engineered to provide protection against many attacks.
      However, the most secure protocol can be compromised if it is
      placed in an insecure environment. To ensure Shibboleth is as
      secure as possible, there are several recommended security
      precautions which should be in place at local sites.</p>

      <ol type="i">
        <li>
          <p>SSL use is optional for origin sites. Federation guidelines
          should be considered when determining whether to
          implement SSL, and, in general, SSL should be used for
          interactions with client machines to provide the
          necessary authentication and encryption to ensure
          protection from man-in-the-middle attacks. It is strongly
          suggested that all password traffic or similarly
          sensitive data should be SSL-protected. Assessment of the
          risk tradeoff against possible performance degradation
          should be performed for all applications.</p>
        </li>

        <li>
          <p>Many other attacks can be made on the several
          redirection steps that Shibboleth takes to complete
          attribute transfer. The best protection against this is
          safeguarding the WAYF service and ensuring that rogue
          targets and origins are not used, generally by
          development of the trust model underneath Shibboleth.
          Shibboleth also leverages DNS for security, which is not
          uncommon, but attacks concerning bad domain information
          should be considered.</p>
        </li>

        <li>
          <p>Information regarding origin users is generally
          provided by the authoritative enterprise directory, and
          the acceptance of requests from target applications can
          be carefully restricted to ensure that all requests the
          SHAR performs are authorized and all information the
          origin provides is accurate. Proper security measures
          should also be in place on directory access and
          population(see <a href=
          "http://www.georgetown.edu/giia/internet2/ldap-recipe/#AccessControl">
          Access Control</a> in the <a href=
          "http://www.georgetown.edu/giia/internet2/ldap-recipe/">LDAP
          recipe</a> for more information). Use of plaintext
          passwords is strongly advised against.</p>
        </li>

        <li>
          <p>Server platforms should be properly secured,
          commensurate with the level that would be expected for a
          campus' other security services, and cookie stores on
          client machines should be well protected.</p>
        </li>
      </ol>
    </blockquote>

    <h4><a name="2.d."></a>2.d. Server Certs</h4>

    <blockquote>
      <p>In the Shibboleth architecture, the SHIRE, SHAR, HS, and AA
      must all have various client and/or server certificates for use in
      signing assertions and creating SSL channels. These should be
      issued by a commonly accepted CA, which may be stipulated by some
      Federation rules. Different federations may require the use of
      different CA's.</p>
    </blockquote>

    <h4><a name="2.e."></a>2.e. Attribute Release Policies</h4>

    <blockquote>
      <p>The Attribute Authority maintains a set of policies called
      Attribute Release Policies (or ARP's) that govern the sharing
      of user attributes with Shibboleth target sites. When a user
      attempts to access a Shibboleth-protected resource, that
      resource's SHAR queries the user's AA for all attributes to
      which it is entitled. The SHAR provides its own name and the
      URL of the resource on behalf of which it is making the
      request.  The AA finds the attributes associated with the
      browser user, determines an "Effective ARP" for this user, and
      then sends to the SHAR only the attributes/values allowed in
      this policy.</p>

      <p>An ARP may be thought of as a sort of filter for outbound
      attributes; it cannot create attributes or data that aren't
      originally present, but it can limit the attributes released
      and the values those attributes may have when released. It
      does not change the information in the data sources in any
      way.</p>

      <p>Each ARP is comprised of one or more rules that specify
      which attributes and values may be released to a target or set
      of targets.  The assignment of rules to various targets is
      quite flexible and includes mechanisms for specifying: that a
      rule should affect all targets (default rule), exact SHAR
      names for which a rule is applicable, regular expressions
      against which SHAR names should be matched to determine if a
      rule is applicable, URL trees for which a rule is
      applicable.</p>

      <p>For each request, an Effective ARP is determined by
      locating all ARP's applicable to the designated user and
      extracting each rule that matches the querying SHAR and
      resource.  Attributes and values that are specified for
      release are included in the effective ARP, while those
      specified for denial are blocked from release.  See section <a
      href="#5.a.i.">5.a.i</a> for details on how ARP's are
      processed.</p>

      
      <p>Various ARP's may be combined in forming the Effective ARP.
      For instance, the Site ARP is administratively maintained and
      applies to all users for which the AA is answerable. User
      ARP's apply to a specific user only, and can be maintained
      either administratively or by the users themselves.  All ARP's
      are specified using the same syntax and semantics.</p>
    </blockquote>

    <h4><a name="2.f."></a>2.f. Designate Contacts</h4>

    <blockquote>
      <p>Since Shibboleth deals both with daily technical and
      operational issues and also with contractual issues, a set of
      contacts should be set up to support the user base and to
      facilitate interactions with other Shibboleth sites and federation
      members. It is recommended that at least technical and
      administrative contacts be designated.</p>
    </blockquote>

    <h4><a name="2.g."></a>2.g. Browser Requirements</h4>

    <blockquote>
      <p>A primary Shibboleth design consideration was to require
      very little or no modification to client machines. The only
      requirement is that a browser is used which supports cookies,
      redirection and SSL. Browser users will have to perform an
      additional click to submit the authentication assertion if
      JavaScript is not functional.</p>
    </blockquote>

    <h4><a name="2.h."></a>2.h. Clocks</h4>

    <blockquote>
      <p><a href="http://www.eecis.udel.edu/~ntp/">NTP</a> should
      be run on all web servers. Shibboleth employs a short handle
      issuance time to protect against replay attacks. Because of
      this, any significant degree of clock skew can hinder the
      ability of users to access sites successfully.</p>
    </blockquote>

    <h4><a name="2.i."></a>2.i. Other Considerations</h4>

    <blockquote>
      <p>Especially for higher education, there are a handful of
      laws enacted which may have important ramifications on the
      disclosure of personal information and attributes. Since
      Shibboleth does not necessarily need to transmit identity, it
      is an ideal solution for many higher education situations.
      Nevertheless, all parties within the United States of America
      are strongly advised to consult the <a href=
      "http://www.ed.gov/offices/OM/fpco/ferpa/">Family Educational
      Rights and Privacy Act of 1974(FERPA)</a>, and all other
      relevant state and federal legislation before deploying
      Shibboleth.</p>
    </blockquote>
    <br>
    <br>
    <hr>
    <br>
     

    <h3><a name="3."></a>3. Installation</h3>

    <h4><a name="3.a."></a>3.a. Software Requirements</h4>

    <p><b>The following requirements are primarily recommendations
    based on the most common ways to run Shibboleth.  However, the
    origin should be able to run under any servlet container
    supporting <span class="fixed">Servlet API v2.3</span> and <span class="fixed">JSP specification
    1.2</span>.</b></p>

    <blockquote>
      <ul type="circle">
        <li><a href=
        "http://http://www.apache.org/dist/httpd/">Apache
        1.3.26+ (&lt;2.0)</a></li>

        <li><a href="http://jakarta.apache.org/tomcat/">Tomcat
        4.1.18-24 LE Java server</a></li>

        <li>
          <a href="http://java.sun.com/j2se/">Sun J2SE JDK v1.4.1_01 and above</a>
        </li>

        <li>
          mod_jk

          <blockquote>
            <p>You may need to build mod_jk against Apache, which
            will generally require GCC or a platform-specific C
            compiler.</p>
          </blockquote>
        </li>

        <li>
          An enterprise authentication mechanism

          <blockquote>
            <p>Ideally, this will be a WebISO or SSO system such as
            <a href= "http://pubcookie.org/">Pubcookie</a>. The
            minimal requirement is for the web server to be able to
            authenticate browser users and supply their identity to
            the Handle Server.</p>
          </blockquote>
        </li>

        <li>
          An enterprise directory service

          <blockquote>
            <p>Shibboleth currently supports retrieving user
            attribute information from an <a href=
            "http://www.openldap.org">LDAP</a> directory. For
            testing purposes, Shibboleth also supports a minimal
            echo responder which will always returns predefined
            attributes.</p>
          </blockquote>
        </li>
      </ul>
    </blockquote>

    <h4><a name="3.b."></a>3.b. Deploy HS and AA</h4>

    <blockquote>
      <ol type="1">
        <li>
          <p>Ensure you have already obtained the proper <a href=
          "http://shibboleth.internet2.edu/release/shib-download.html">tarball</a>.</p>
        </li>

        <li>
          <p>The archive will expand into a <span class="fixed">shibboleth-origin-1.0/</span>
          directory(<span class="fixed">/opt</span> recommended).</p>
        </li>

        <li>
          <p>Run the following command to move the Java files into
          Tomcat's tree:</p>

          <blockquote>
            <span class="fixed">cp /opt/shibboleth-origin-1.0/dist/shibboleth.war
            /usr/local/tomcat/webapps/</span>
          </blockquote>
        </li>

        <li>
          <p>Tomcat 4.1.x requires that several Java jarfiles used
          by Shibboleth be located in a special "endorsed" folder to
          override obsolete classes that Sun includes with their JVM.
          To deal with this problem use the following command, adjusting
          paths as needed:</p>
          <blockquote>
            <span class="fixed">$ cp /opt/shibboleth-origin-1.0/endorsed/*.jar /usr/local/tomcat/common/endorsed</span>
          </blockquote>
         <p>Different versions of Tomcat or other Java servers may have
         other locations in which to place these files or deal with this
         problem. Refer to your application server's documentation to
         find out how to properly endorse classes, if necessary.</p>
        </li>

        <li>
          <p>Restart Tomcat, which will automatically detect that
          there has been a new .war file added. This file will by
          default be expanded into
          <span class="fixed">/usr/local/tomcat/webapps/shibboleth</span>.</p>
        </li>

        <li>
          <p>Apache must be told to map the URL's for the
          Shibboleth HS and AA to Tomcat. Two popular ways of doing
          this are to include the following text directly in
          <span class="fixed">httpd.conf</span>, or to place <span class="fixed">Include
          conf/mod_jk.conf</span> in <span class="fixed">httpd.conf</span>, and place
          the following lines in
          <span class="fixed">/etc/httpd/conf/mod_jk.conf</span>:</p>

          <blockquote>
            <span class="fixed">--------- begin ---------<br>
            &lt;IfModule !mod_jk.c&gt;<br>
            &nbsp;LoadModule jk_module libexec/mod_jk.so<br>
            &lt;/IfModule&gt;<br>
            <br>
            JkWorkersFile
            "/usr/local/tomcat/conf/jk/workers.properties"<br>
            JkLogFile "/usr/local/apache/logs/mod_jk.log"<br>
            <br>
            JkLogLevel emerg<br>
            <br>
            JkMount /shibboleth/* ajp13<br>
            <br>
            --------- end ---------</span>
          </blockquote>
        </li>

        <li>
          <p>Tomcat's <span class="fixed">/conf/server.xml</span>
          ships by default with the Coyote/JK2 connector enabled, which
          fails with Shibboleth due to the lack of support for <span
          class="fixed">REMOTE_USER</span>.  This connector must be
          commented out.  Then, uncomment and modify the traditional AJP
          1.3 connector as follows:</p>

          <ol type="A">
            <li>
              <p>Add <span class="fixed">address="127.0.0.1"</span> inside the
              <span class="fixed">&lt;Ajp13Connector&gt;</span> configuration
              element to prevent off-host access.</p>
            </li>

            <li>
              <p>Add <span class="fixed">tomcatAuthentication="false"</span> to the
              <span class="fixed">&lt;Ajp13Connector&gt;</span> configuration element
              to ensure that the user's identity is passed from
              Apache to the servlet environment.</p>
            </li>
          </ol>
        </li>
      </ol>
    </blockquote>
    <br>
    <hr>
    <br>
     

    <h3><a name="4."></a>4. Getting Running</h3>

    <h4><a name="4.a."></a>4.a. Basic Configuration</h4>

    <blockquote>
      <p>The main configuration file for Shibboleth's origin side is
      located in
      <span class="fixed">/webapps/shibboleth/WEB-INF/classes/conf/origin.properties.</span>. This file contains configuration information
      for the origin side in several sections.  The configuration
      must be consistent with values elsewhere in the deployment,
      such as the <a href="#4.c.">HS' certificate</a> and with
      directory access bindings, etc., or access errors may occur.</p>
      
      <p>All pathnames are relative, and have an effective root
      path of
      <span class="fixed">$TOMCAT_HOME/webapps/shibboleth/WEB-INF/classes/</span>.  To
      specify files outside of the webapp, specify a full URI, such
      as <span class="fixed">file:///opt/shibboleth-origin-1.0/</span>.</p>
      
      <p>Fields that are purple are optional; grey fields are
      mandatory.</p>

      
	  <p>These are the variables that may be specified for each
      component of <span class="fixed">origin.properties</span>:</p>

      <br>
      <p>General Configuration:</p>

      <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.issuer
              = &lt;domain name&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the DNS name the HS should use for
              itself in issuing assertions.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.siteName
              = &lt;URI&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the the <span
              class="fixed">URI</span> to use as the name of
              the origin site as a whole.  This field is primarily
              meant to be populated in the context of the federation
              in which the origin site resides, is intended to be
              globally unique, and will typically be assigned by the
              federation.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.AAUrl
              = &lt;url&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the <span class="fixed">URL</span>
              at which the HS' corresponding AA may be
              contacted.</p>
          </dd>

          <dd class="attributeoptlong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.username
              = &lt;var&gt;</span>
          </dd>

          <dd class="valueopt">
              <p>Specifies the HTTP request header that should be used
              to acquire the user's principal name from the
              authentication service.  Defaults to <span
              class="fixed">REMOTE_USER</span>.</p>
          </dd>

          <dd class="attributeoptlong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.authMethod
              = &lt;uri&gt;</span>
          </dd>

          <dd class="valueopt">
              <p>Specifes the URI used to populate <span
              class="fixed">AuthenticationMethod</span> in the SAML
              attribute assertion.  This corresponds to the method used
              to authenticate users by the authentication service used
              by the HS.  Some common authentication methods and
              corresponding URI's are listed below; for a complete list,
              please consult section 7.1 of the SAML 1.1 core
              specifications or your federation's guidelines.</p>
              <table border=2 cellpadding=0 cellspacing=0>
                <tr>
                  <td><span class="fixed">urn:oasis:names:tc:SAML:1.0:am:password</span></td>
                  <td>The authentication was performed using a password.</td>
                </tr>
                <tr>
                  <td><span class="fixed">urn:ietf:rfc:1510</span></td>
                  <td>The authentication was performed using Kerberos.</td>
                </tr>
                <tr>
                  <td><span class="fixed">urn:oasis:names:tc:SAML:1.0:am:X509-PKI</span></td>
                  <td>The authentication was performed using a
                  certificate and key issued to the end user.  More
                  specific forms of PKI authentication such as SPKI and
                  XKMS are also assigned URN's in the SAML specs.</td>
                </tr>
              </table>
          </dd>
      </dl>

      <br>
      <p>Assertion Signing:</p>

      <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.keyStorePath
              = &lt;pathname&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the location of the Java keystore
              containing the x.509 certificate and matching private
              key to be used by the HS.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.keyStorePassword
              = &lt;password&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the password to the referenced
              keystore.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.keyStoreKeyAlias
              = &lt;alias&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the alias used for accessing the private
              key.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.keyStoreKeyPassword
              = &lt;password&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the password used to retrieve the private key.</p>
          </dd>

          <dd class="attributeoptlong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleServlet.certAlias
              = &lt;alias&gt;</span>
          </dd>

          <dd class="valueopt">
              <p>Specifies the alias for the certificate
              corresponding to the private key used by the HS. 
              Defaults to the private key's alias.</p>
          </dd>
      </dl>
      <br>
      
      <p>General AA Configuration:</p>

      <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.AAServlet.authorityName
              = &lt;domain name&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the name of the AA, which is typically
              the domain name of the server running it.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.AAServlet.passThruErrors
              = &lt;true/false&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies whether the AA should pass on internal errors
              to the SHAR for debugging purposes.  Defaults to <span
              class="fixed">false</span>.</p>
          </dd>
      </dl>

      <p>AA Attribute Resolution:</p>

        <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.attrresolv.AttributeResolver.ResolverConfig
              = &lt;pathname&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the location of the configuration file
              for the resolver the AA uses to build attributes. 
              Defaults to <span
              class="fixed">/conf/resolver.xml</span>.  For
              information on how to configure and use the attribute
              resolver, consult section <a href="4.e.">4.e</a>.</p>
          </dd>
        </dl>

      <p>ARP Configuration:</p>

      <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.arp.ArpRepository.implementation
              = &lt;string&gt;</span>
          </dd>

          <dd class="value">
              <p>References the type of ARP repository implemented. 
              Shibboleth provides a built-in ARP repository
              specified by
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.arp.
              provider.FileSystemArpRepository</span>.</p>
              
              <p>Note that the set of principals that an ARP applies
              to is not expressed by the ARP itself, but rather the
              implementation of the ARP repository.  For example, if
              the ARP repository were implemented in LDAP, the ARP's
              that apply to a user would be attributes of that
              user's personal LDAP entry, and the site ARP would be
              an attribute of an entry representing the site.  While
              not performed by the built-in ARP repository, a
              repository implementation might also implement group
              ARP's; for example, in an LDAP directory, the user
              entry might have some group membership attributes that
              refer to group entries, and those group entries would
              have ARP attributes, and all those ARP's would be
              applicable.</p>
          </dd>

          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository.Path
              = &lt;pathname&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies the relative or absolute path to the
              folder containing the ARP files.</p>
          </dd>

          <dd class="attributeoptlong">
              <span class="fixed">edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository.ArpTTL
              = &lt;seconds&gt;</span>
          </dd>

          <dd class="valueopt">
              <p>Specifies the duration in <span
              class="fixed">seconds</span> that ARP's may be
              cached by the AA.  Defaults to <span
              class="fixed">0</span>, or no caching.</p>
          </dd>
      </dl>
    
      <p>Handle Repository Configuration:</p>

      <dl>
          <dd class="attributeoptlong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleRepository.implementation
              = &lt;string&gt;</span>
          </dd>

          <dd class="valueopt">
              <p>Specifies the method by which the HS and AA share
              handles.  These are by default passed by memory(which
              can be specified explicitly using
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.
              MemoryHandleRepository</span>), and may also be passed
              using symmetric encryption with
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository</span>.</p>
          </dd>
      </dl>

      <p>edu.internet2.middleware.shibboleth.hs.provider.
      MemoryHandleRepository <font color="#5555EE">(specify
      if
      <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleRepository.
      implementation</span> is <span class="fixed">MemoryHandleRepository</span>)</font></p>

      <blockquote>
        <dl>
            <dd class="attributeoptlong">
<span class="fixed">edu.internet2.middleware.shibboleth.hs.BaseHandleRepository.handleTTL
            = &lt;seconds&gt;</span>
            </dd>

            <dd class="valueopt">
              <p>Specifies the time in <span
              class="fixed">seconds</span> for which issued handles
              are valid.  Defaults to <span
              class="fixed">1800</span>, or 30 minutes.  The time
              should be long enough to allow for clock skew and short
              enough to protect against various attacks.  Consult your
              federation guidelines for further advice.</p>
            </dd>
          </dl>
      </blockquote>

      <p>edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository <font color="#5555EE">(specify
      if
      <span class="fixed">edu.internet2.middleware.shibboleth.hs.HandleRepository.
      implementation</span> is <span class="fixed">CryptoHandleRepository</span>)</font></p>

      <p>In order to use the crypto repository implementation, you must
      have a <span class="fixed">DESede</span> secret key in a
      keystore of type <span class="fixed">JCEKS</span>.  The
      origin distribution includes a program that will automatically
      generate such a key.  In order to invoke it, run <span
      class="fixed">./ant genSecret</span>, which will create a
      keystore in <span
      class="fixed">$SHIB_HOME/src/conf/handle.jks</span> that
      includes the key, with an alias of <span
      class="fixed">handleKey</span> and a password of <span
      class="fixed">shibhs</span>.  If <span
      class="fixed">./ant dist</span> is run subsequently, this
      keystore will be included in the webapp archive that is
      created.</p>

      <blockquote>
        <dl>
            <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository.keyStorePath
            = &lt;pathname&gt;</span>
            </dd>

            <dd class="value">
              <p>Specifies the path to the keystore containing the
              key used to encrypt passed principal identifiers.</p>
            </dd>
  
            <dd class="attributelong">
<span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository.keyStorePassword 
            = &lt;password&gt;</span>
            </dd>

            <dd class="value">
              <p>Specifies the password for the keystore.</p>
            </dd>
  
            <dd class="attributelong">
<span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository.keyStoreKeyAlias
             = &lt;password&gt;</span>
            </dd>

            <dd class="value">
              <p>Specifies the alias for the appropriate encryption
              key within the keystore.</p>
            </dd>
  
            <dd class="attributelong">
<span class="fixed">edu.internet2.middleware.shibboleth.hs.provider.CryptoHandleRepository.keyStoreKeyPassword
            = &lt;password&gt;</span>
            </dd>

            <dd class="valueopt">
              <p>Specifies the password used to retrieve the key.</p>
            </dd>
  
            <dd class="attributeoptlong">
<span class="fixed">edu.internet2.middleware.shibboleth.hs.CryptoHandleRepository.handleTTL
            = &lt;seconds&gt;</span>
            </dd>

            <dd class="valueopt">
              <p>Specifies the time in <span
              class="fixed">seconds</span> for which issued handles
              are valid.  Defaults to <span
              class="fixed">1800</span>, or 30 minutes.  The time
              should be long enough to allow for clock skew and short
              enough to protect against various attacks.  Consult your
              federation guidelines for further advice.</p>
            </dd>
  
        </dl>
      </blockquote>

      <p>Federation Configuration:</p>

        <dl>
          <dd class="attributelong">
              <span class="fixed">edu.internet2.middleware.shibboleth.audiences
              = &lt;URI's&gt;</span>
          </dd>

          <dd class="value">
              <p>Specifies a list of <span
              class="fixed">URI</span>'s that will be used for
              the <span class="fixed">Audience</span> field of
              the SAML attribute assertion.  All URI's listed will
              be sent with any assertion issued by the AA.  These
              URI's are defined and provided by and correspond to
              federations.</p>

              <p>Note that the values of the URI's here <b>must</b>
              match one of the policy URI's accepted by the
              receiving target in the <span
              class="fixed">[policies]</span> section of <span
              class="fixed">shibboleth.ini</span> or
              interoperation will fail by design.
          </dd>
        </dl>

    </blockquote>
    <br>
     

    <h4><a name="4.b."></a>4.b. Key Generation and Certificate
    Installation</h4>

    <blockquote>
      <p>The SAML messages generated by the HS must be digitally
      signed. Each HS must be issued a private and public keypair,
      which is stored in a Java keystore. The current
      implementation of Shibboleth requires the use of an ordinary
      file-based keystore. The keytool program is included with the
      Java development and runtime kits. Access parameters to the
      keystore will need to be consistent with those specified in
      <span class="fixed">origin.properties</span>.</p>

      <p>A sample keystore is included in the distribution and can
      be found in
      <span class="fixed">/usr/local/tomcat/webapps/shibboleth/WEB-INF/classes/conf/keystore.jks</span>
      with a password of <span class="fixed">shibhs</span>.  It is intended
      to serve as an example and not as a production keystore.</p>

      <p>The following commands will generate a new RSA keypair and
      store it in the <span class="fixed">keystore.jks</span> file, with a keyentry
      alias of <span class="fixed">hs</span> and new passwords of your choosing:</p>

      <blockquote>
        <span class="fixed">$ cd /usr/local/tomcat/webapps/shibboleth/WEB-INF/classes/conf<br>
        $ keytool -storepasswd -keystore keystore.jks -new
        &lt;newpassword&gt;<br>
        $ keytool -genkey -keystore keystore.jks -alias hs -keyalg
        rsa -keysize 2048<br>
        </span>
      </blockquote>

      <p>You will be prompted for passwords during key generation
      as needed, to access the keystore and assign the key itself
      its own password. You will also be prompted for the
      distinguished name components to associate with the key. This
      DN will be placed in a self-signed certificate and will be
      the name that is associated with your HS by Shibboleth. In
      particular, the first component you enter for Name will be
      the <span class="fixed">Common Name</span>(when keytool asks for first and last
      name, common name is intended), which in most cases should be
      the hostname of the HS system. Note that a specific federation of
      sites may dictate what type of key algorithm, key size, or
      validity period is appropriate.</p>

      <p>Once you have a keypair generated, the self-signed certificate
      must be replaced with a certificate signed by a CA acceptable to
      the federation you will be joining. Shibboleth is generally able to
      climb trust chains to reach an intermediate CA's root CA.  Note
      that the intermediate CA's signing certificate must still be
      signed by a root CA recognized by the federation.</p>

      <p>To generate a certificate signing request for a CA, use
      the following command:</p>

      <blockquote>
        <span class="fixed">$ keytool -certreq -keystore keystore.jks -alias hs
        -file &lt;csr-file&gt;<br>
        </span>
      </blockquote>

      <p>The contents of <span class="fixed">&lt;csr-file&gt;</span> can then be sent
      to a CA for signing. You will receive a signed certificate in
      return in a file. To install the new certificate into your
      keystore, use the following command:</p>

      <blockquote>
        <span class="fixed">$ keytool -import -keystore keystore.jks -alias hs
        -file &lt;cert-file&gt;</span>
      </blockquote>

      <p>Note that if the signing CA's certificate is not already
      installed in your keystore as a trusted signer, you may need
      to download the CA's root certificate and import it into the
      keystore file under a different alias, using a command
      similar to the above.</p>

	  <p>For information on sharing certificate/key pairs between Apache 
	  and Java keystores see section <a href="#5.b.">5.b.</a>.</p>
    </blockquote>

    <h4><a name="4.c."></a>4.c. Linking the Authentication System
    to the HS</h4>

    <blockquote>
      <p>The interaction between the HS and the local authentication
      system is implemented by supplying the HS with the identity of
      the browser user. Most often, this will mean protecting the HS
      servlet with some form of local authentication that populates
      <span class="fixed">REMOTE_USER</span>. Location blocks can be added to
      <span class="fixed">httpd.conf</span>, associating the appropriate
      authentication mechanism with the URL of the HS servlet. The
      following example demonstrates association of a very basic
      authentication method with the HS:</p>

      <blockquote>
        <span class="fixed">&lt;Location /shibboleth/HS&gt;<br>
        AuthType Basic<br>
        AuthName "Internet2 Handle Service"<br>
        AuthUserFile /usr/local/apache/conf/user.db<br>
        require valid-user<br>
        &lt;/Location&gt;<br>
        </span>
      </blockquote>

      <p>Note that .htaccess files cannot be used for this purpose
      because URL's are "virtualized" by Tomcat.</p>

      <p>It is recommended that the origin be tested at the end of
      this process using the process described in section <a href=
      "#6.a.">6.a</a>.</p>
    </blockquote>

    <h4><a name="4.c.i."></a>4.c.i. Enabling client certificate
    authentication <font color="#5555EE">(optional)</font></h4>

    <blockquote>
      <blockquote>

      <p>Shibboleth supports client certificate authentication by
      utilization of a filter that relies on the web server to do all
      processing to ensure that the certificate is both valid and
      appropriate for the application.  An example deployment descriptor
      is included with the Shibboleth distribution at <span
      class="fixed">$SHIB_HOME/webAppConfig/origin-client-cert.xml</span>.
      To enable the filter, add the following to the deployment
      descriptor (<span class="fixed">web.xml</span>):</p>

      <blockquote>
        <span class="fixed">&nbsp;&nbsp;&lt;filter&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Client Cert AuthN Filter<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-name&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-class&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edu.internet2.middleware.shibboleth.utils.ClientCertTrustFilter<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-class&gt;<br>
        &nbsp;&nbsp;&lt;/filter&gt;<br>
        <br>
        <br>
        &nbsp;&nbsp;&lt;filter-mapping&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Client Cert AuthN Filter<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-name&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;url-pattern&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/HS<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;/url-pattern&gt;<br>
        &nbsp;&nbsp;&lt;/filter-mapping&gt;<br></span>
     </blockquote>

     <p>By default, the filter pulls the principal name out of the <span
     class="fixed">CN</span> of the cert's <span
     class="fixed">Subject</span> by using regular expression
     grouping.  This may be done using patterns such as:</p>

     <blockquote>
       <span class="fixed">regex: '.*CN=([^,/]+).*' match group: 1</span>
     </blockquote>

     <p>The servlet filter will accept two initialization parameters,
     <span class="fixed">regex</span> and <span
     class="fixed">matchGroup</span> that can be used to extract
     the principal name differently.</p>

      </blockquote>
    </blockquote>

    <h4><a name="4.d."></a>4.d. Establishing default ARP's for the
    origin community</h4>
    
    <p><b>For a more basic introduction to ARP's, please refer to
    section <a href="#2.e.">2.e</a>.</b></p>

    <blockquote>
      <p>An ARP determines which attributes are released to a SHAR
      when a user tries to access a resource.  It acts as a sort of
      filter on user information contained in the authoritative
      directory, deciding what can be released to whom, but not
      modifying or creating information itself.  ARP's are generally
      administered by the site, but Shibboleth will provide for users to
      broker control of their own information and privacy by
      allowing them to create ARP's pertaining to themselves.</p>

      <p>It is recommended that a set of policies be established
      between an origin and frequently accessed targets to specify
      default releases of expected attributes.  Federation guidelines may
      provide more information on population of ARP's.</p>

      <p>Currently, there is no direct mechanism for users to create
      their own ARP's besides direct XML writing.  In future
      versions, a GUI will be provided for simpler management of
      ARP's.  Care should be given to balancing giving sufficient
      control over information to users and avoiding access
      problems.  For example, users may decide to restrict the
      release of their personal information to such a degree that
      access to a site for a class may become impossible because
      Shibboleth cannot release enough information to grant
      access.</p>

	  <p>The Shibboleth distribution contains an example site arp that 
	  releases the eduPersonScopedAffiliation attribute to all targets.  For 
	  more precise information regarding how ARP's are processed or 
	  syntactically formed, please refer to section <a href="#5.a.i.">5.a.i</a>.</p>
    </blockquote>

	<h4><a name="4.e."></a>4.e. Modifying the default Attribute Resolver configuration</h4>
	<blockquote>
	<p>The resolver.xml file controls the retrieval of attributes from enterprise repositories, and the process of mapping them to Shibboleth/SAML attributes. For more precise information regarding how attributes are processed or syntactically formed, please refer to section <a href="#5.c.">5.c.</a></p>

	<p>In order to make the Shibboleth software operational, however, minor edits must be made to the example version of the resolver.xml file. The file can be found at <span class="fixed">/webapps/shibboleth/WEB-INF/classes/conf/resolver.xml.</span>  Two changes are necessary:</p>

	<p>	1. The value of the smartScope attribute should be changed to the Domain Name value submitted to the Federation. It appears on two SimpleAttributeDefinition elements: eduPersonScopedAffiliation and eduPersonPrincipalName.</p>

	<p>2. The comment indicators should be removed from around the definitions of those two elements ( &lt;!-- and --&gt; ).</p> 
	</blockquote>
    <br>
    <hr>
    <br>

    <h3><a name="5."></a>5. Advanced Configuration</h3>

    <h4><a name="5.a."></a>5.a. ARP Overview</h4>

    <blockquote>
      <h5>This section applies primarily to the syntactic and
      technical details of ARP's. For basic information on and
      explanation of what an ARP is and how it should be managed,
      please refer to sections <a href="#2.e.">2.e</a> and <a href=
      "#4.d.">4.d</a>.</h5>

      <p>Every ARP file contains one ARP.  ARP's may be specified either
      as the site ARP or user ARP's.  The site ARP pertains to every
      principal for whom the AA retrieves information; a user ARP
      applies only to the individual user for whom it is defined.  The
      set of principals to whom the ARP applies is defined by the name
      of the ARP file: the site ARP is stored in <span
      class="fixed">arp.site.xml</span> and user ARP's are stored as
      <span class="fixed">arp.user.$PRINCIPALNAME.xml</span>.
      Up to two ARP's will apply to a principal: the site ARP, and the
      user ARP for that principal.</p>

      <p>Each ARP acts as a container that holds a set of ARP rules
      that are applicable to the principals that ARP is effective
      for.  Each ARP rule specifies a single release policy within
      the ARP container pertaining to a specific set of targets.
      This set of targets may be specified as a specific SHAR, a
      SHAR tree, or a regular expression, and becomes the ARP rule's
      target definition. Each ARP rule may contain specifications
      regarding the release of any number of attribute values to
      requests matching that ARP rule for that user. ARP rules may
      be flagged as default, implying that they are always applied
      to any user matched by the ARP container.  Note that ARP's may
      also be used to restrict specific attribute/value pairs in
      addition to restricting or releasing individual attributes.</p>

      <p>When a query is received, the AA generates an effective
      ARP, which is the fully evaluated set of ARP rules regarding
      that SHAR based on all ARP containers applicable to the
      principal.  This effective ARP is then applied to attribute
      values retrieved from the directory and the appropriate
      assertion is constructed.  Default rules are always
      included in construction of the effective ARP.</p>

      <!-- ##To be included in future releases of the deploy guide.
  
      <dl>
          <dd class="demo">
            <img src="arp.gif">
          </dd>
          <dd class="demo">
            <p>In this picture, meant to demonstrate the structure
            of ARP's, if all ARP's are taken to mean "Release this
            attribute," then attributes 1-4 will be released if that
            principal tries to access site A.  ARP #1 could not
            restrict the release of attribute 4 to site A.</p>
          </dd>
      </dl>

      -->

    </blockquote>

    <h4><a name="5.a.i."></a>5.a.i. ARP Processing</h4>

    <blockquote>
      <blockquote>
        <p>When a request arrives from a particular SHAR, the
        applicable set of ARP rules are parsed into an effective
        ARP.  This parsing is done as follows:</p>
        
        <ol type=1>
          <li>Identify all ARP's that should be applied to a particular
          principal.  This is done by isolating the files in the folder
          specified by <span
          class="fixed">edu.internet2.middleware.shibboleth.aa.arp.provider.FileSystemArpRepository.Path</span> that have the
          name either arp.site.xml or arp.user.$PRINCIPALNAME.xml.</li>
          <li>Find all ARP rules relevant to the query:
          <ol type=i>
            <li>Any ARP rules within the identified ARP's designated
            as defaults are automatically included in the effective
            ARP without performing any matching functions.</li>
            <li>For each non-default rule in each identified ARP,
            the matching functions specified in the rule's target
            definition are performed. A separate matching function
            is performed for the requesting SHAR and the resource on
            behalf of which the SHAR is making the request.</li>
            <li>Each matching function evaluates to <span class="fixed">TRUE</span> if
            the match is successful or <span class="fixed">FALSE</span> if it is
            unsuccessful. If both functions evaluate to
            <span class="fixed">TRUE</span>, the rule is included in the Effective
            ARP.</li>
          </ol></li>
          <li>Construct the Attribute Filter:
          <ol type=i>
            <li>For each attribute, compile a temporary list of
            associated rules that includes all values with a release
            qualifier of <span class="fixed">permit</span>.</li>
            <li>Subtract from this list all attribute values with
            rules specifying a release qualifier of <span class="fixed">deny</span>.
            The resulting list represents the allowable release
            values for the attribute and is used as a mask for the
            values which are returned from the Attribute
            Resolver.</li>
            <li>If a statement specifies that all values should be
            permitted, then specific <span class="fixed">deny</span> qualifiers for
            specific values should still be enforced.  If a
            statement specifies that all values should be denied,
            then <span class="fixed">permit</span> qualifiers for specific values will
            be ignored.</li>
          </ol></li>
          <li>Using the mask and attributes returned from the
          Attribute Resolver, an assertion is constructed.</li>
        </ol>
      </blockquote>
    </blockquote>
    

    <h4><a name="5.a.ii."></a>5.a.ii. ARP Syntax</h4>

    <blockquote>
      <blockquote>

      <p>Each ARP is described by an XML file based on a standard
      <span class="fixed">.xsd</span> schema.  It consists of a standard
      <span class="fixed">AttributeReleasePolicy</span> element referencing the
      appropriate <span class="fixed">xsi:schemaLocation</span> and a self-explanatory
      <span class="fixed">Description</span> element followed by any number of
      <span class="fixed">Rule</span> elements.  Each <span class="fixed">Rule</span> element must
      consist of a <span class="fixed">Target</span> element and one or more
      <span class="fixed">Attribute</span> elements.  The <span class="fixed">Target</span> element
      specifies the rules by which the target definition is formed. 
      The <span class="fixed">Attribute</span> elements specifies the name and values
      of the attributes that may be released.</p>

      <p>The simplest possible ARP is as follows, which releases
      <span class="fixed">eduPersonScopedAffiliation</span> to any target for the
      users the ARP applies to:</p>

        <blockquote>
          <span class="fixed">
          &lt;?xml version=&quot;1.0&quot;?&gt;<br>
          
          &lt;AttributeReleasePolicy
          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
          xmlns=&quot;urn:mace:shibboleth:arp:1.0&quot;
          xsi:schemaLocation=&quot;urn:mace:shibboleth:arp:1.0
          shibboleth-arp-1.0.xsd&quot;&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
          &lt;Description&gt;Simplest possible
          ARP.&lt;/Description&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
          &lt;Rule&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Target&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyTarget/&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Target&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Attribute
          name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyValue release=
          &quot;permit&quot;/&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Attribute
          &gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Rule
          &gt;<br>

          &lt;/AttributeReleasePolicy&gt;<br>

          </span>
        </blockquote>
      </blockquote>

      <p>All ARP's must take the same basic form.  A detailed
      description of how each element of the <span class="fixed">Rule</span> element
      may be sub-populated follows:</p>

      <p>The <span class="fixed">Target</span> element:</p>
      
      <blockquote>
      
        <p><span class="fixed">Target</span> may contain either the
        <span class="fixed">AnyTarget</span> element, which will cause the
        <span class="fixed">Target</span> to always return <span class="fixed">TRUE</span>, or both the
        <span class="fixed">Requester</span> element, which provides for matches to be
        performed against the SHAR name and the <span class="fixed">Resource</span>
        element, which provides for matches to be performed against
        the requested URL.</p>    
      
        <p>There are three matches that may be performed by the AA
        in evaluating ARP's by using the <span class="fixed">matchFunction</span>
        component of the <span class="fixed">Requester</span> and <span class="fixed">Resource</span>
        elements.  The following match patterns may be
        specified directly following the <span class="fixed">Requester</span> or
        <span class="fixed">Resource</span> elements, such as <span class="fixed">&lt;Requester
        matchFunction=&quot;urn:mace:shibboleth:arp:matchFunction:regexMatch&quot;&gt;</span>:</p>

        <ul type=disc>
          <li>
            <p><span class="fixed">urn:mace:shibboleth:arp:matchFunction:exactShar
            </span></p>
            <blockquote>
              <p>May be used with the <span class="fixed">Requester</span>
              element.</p>
              
              <p>Evaluates to <span class="fixed">TRUE</span> when the string content
              of the <span class="fixed">Requester</span> element matches exactly the
              name of the requesting SHAR. Otherwise evaluates to
              <span class="fixed">FALSE</span>.  Serves as the default value
              associated with <span class="fixed">Requester</span> if none is
              specified.</p>
            </blockquote>
          </li>
          <li>
            <p><span class="fixed">urn:mace:shibboleth:arp:matchFunction:resourceTree
            </span></p>
            <blockquote>
              <p>May be used with the <span class="fixed">Resource</span> element.</p>

              <p>Evaluates to <span class="fixed">TRUE</span> when the location of 
              the resource either matches exactly or begins with
              the string content of the <span class="fixed">Resource</span> element.
              Otherwise evaluates to <span class="fixed">FALSE</span>.</p>
            </blockquote>
          </li>
          <li>
            <p><span class="fixed">urn:mace:shibboleth:arp:matchFunction:regexMatch
            </span></p>
            <blockquote>
              <p>May be used with both the <span class="fixed">Requester</span>
              and <span class="fixed">Resource</span> elements.</p>

              <p>Evaluates to <span class="fixed">TRUE</span> when the name of the
              requesting SHAR or the requested URL tree is a valid
              match of the regular expression represented as the
              content of the containing element. Otherwise evaluates
              to <span class="fixed">FALSE</span>. Regular expressions are evaluated in
              accordance with the the <a
              href="http://java.sun.com/j2se/1.4/docs/api/java/util/
              regex/Pattern.html#sum">Java 1.4 Pattern API</a>.</p>
            </blockquote>
          </li>
        </ul>
      
    </blockquote>

      <p>The <span class="fixed">Attribute</span> element:</p>
      
      <blockquote>
      
        <p>The <span class="fixed">Attribute</span> element must always specify the
        URN of the attribute whose release parameters it specifies.
        Additionally, it must contain either the <span class="fixed">AnyValue</span>
        element or one or more <span class="fixed">Value</span> elements.  These
        elements, in turn, must specify either <span class="fixed">release</span> =
        <span class="fixed">permit</span> or <span class="fixed">deny</span>.  The <span class="fixed">Value</span>
        element must then contain one value for which the rule
        applies.  Examples:</p>

        <blockquote>
          <span class="fixed">
          &lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot;&gt;<br>
          &nbsp;&nbsp;&lt;AnyValue release=&quot;Permit&quot;&gt;<br>
          &lt;/Attribute&gt;<br>
          </span><br>
          <p>Permits the release of <span class="fixed">eduPersonPrincipalName</span>
          with any value.</p>
        </blockquote>
         
        <blockquote>
          <span class="fixed">
          &lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>
          &nbsp;&nbsp;&lt;Value release=&quot;deny&quot;&gt;member@example.edu&lt;/Value&gt;<br>
          &lt;/Attribute&gt;<br>
          </span><br>
          <p>Denies the release of
          <span class="fixed">eduPersonScopedAffiliation</span> value
          <span class="fixed">member@example.edu</span>.  Other values of the
          attribute may still be released if so specified by a
          <span class="fixed">permit</span> ARP.</p>
        </blockquote>
      </blockquote> 
      
      <!-- ##To be included in future releases.  Not yet implemented.
      
      <p>There is also a special <span class="fixed">AttributeIdentifier</span>
      element that allows internal references to an attribute
      within an ARP.  This is useful for quickly applying multiple
      rules to the same target.  It is used as follows:</p>

        <blockquote>
          <span class="fixed">
          &nbsp;&nbsp;&lt;Rule&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Target&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AnyTarget/&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;/Target&gt;<br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Attribute
          name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Value
          release=&quot;permit&quot;&gt;member@example.edu&lt;/Value
          &gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&lt;/Attribute&gt;<br>
          
          &nbsp;&nbsp;&lt;/Rule&gt;<br>
          
          &nbsp;&nbsp;&lt;AttributeReference identifier=&quot;http://www.example.edu/attributes/attribute1&quot;&gt;<br>

          &nbsp;&nbsp;&lt;Attribute name=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot; identifier=&quot;http://www.example.edu/attributes/attribute1&quot;&gt;<br>

          &nbsp;&nbsp;&nbsp;&nbsp;&lt;Value release=&quot;permit&quot;&gt;student@example.edu&lt;Value&gt;<br>

          &nbsp;&nbsp;&lt;/Attribute&gt;<br>
          </span>
      -->
      
        </blockquote>
    <h4><a name="5.b."></a>5.b. Sharing certificate/key pairs
    between Apache and Java keystores <font color="#5555EE">(optional)</font></h4>

    <blockquote>
      <blockquote>
        <p>The JDK includes the command line program
        <span class="fixed">keytool</span> for managing Java keystores. This utility
        cannot import or export private key information, making it
        difficult to use the same private key and certificate for
        Apache and Java-based applications. The Shibboleth
        distribution includes <span class="fixed">extkeytool</span>, a program that
        can be used in conjunction with <span class="fixed">keytool</span> to perform
        these tasks. Select the appropriate step-by-step procedure
        for your situation from the following guides.</p>
        
        <p>Before running <span class="fixed">extkeytool</span>, the variable
        SHIB_HOME must be set to the path to the directory where the
        Shibboleth tarball was exploded(typically
        /opt/shibboleth-origin-1.0/).</p>

        <p><b>If you have a pre-exiting RSA key/certificate
        combination in a keystore and you would like to use it with
        Apache:</b></p>

        <ol type="1">
          <li>
            <p>Determine the alias of the keystore keyEntry
            containing the key you would like to use in your Apache
            setup. Assuming that your keystore is named
            <span class="fixed">yourstore</span>, the following command should
            present a list of the entries in the keystore.</p>

            <blockquote>
              <p><span class="fixed">$ keytool -list -v -keystore yourstore</span></p>
            </blockquote>
          </li>

          <li>
            <p>Assuming that you identified the appropriate alias
            as <span class="fixed">youralias</span> and the password for the keystore
            is <span class="fixed">yourpass</span>, enter the following command to
            export the key in Base64-encoded pkcs8 format.</p>

            <blockquote>
              <p><span class="fixed">$ extkeytool -exportkey -keystore yourstore
              -alias youralias -storepass yourpass -rfc -file
              yourkey.pkcs8</span></p>
            </blockquote>
          </li>

          <li>
            <p>In order to use this key with Apache, you must
            convert it to PEM-encoded RSA native format. You have
            the option of storing the key unencrypted or
            encrypted:</p>

            <ol type="A">
              <li>
                <p>To use the unencrypted format, enter the
                following command for the conversion:</p>

                <blockquote>
                  <p><span class="fixed">$ openssl pkcs8 -in yourkey.pkcs8
                  -nocrypt|openssl rsa -out yourkey.key</span></p>
                </blockquote>
              </li>

              <li>
                <p>To use the encrypted format, enter the following
                command for the conversion:</p>

                <blockquote>
                  <p><span class="fixed">$ openssl pkcs8 -in yourkey.pkcs8
                  -nocrypt|openssl rsa -des3 -out
                  yourkey.enckey</span></p>
                </blockquote>
              </li>
            </ol>
          </li>

          <li>
            <p>The following command will export the corresponding
            certificate.</p>

            <blockquote>
              <p><span class="fixed">$ keytool -export -keystore yourstore -alias
              youralias -rfc -file yourcert</span></p>
            </blockquote>
          </li>

          <li>
            <p>Set the <span class="fixed">mod_ssl</span>
            <span class="fixed">SSLCertificateKeyFile</span> and
            <span class="fixed">SSLCertificateFile</span> directives to point to the
            two files you have just created. Take care to remove
            any temporary files you created (i.e.
            <span class="fixed">yourkey.pkcs8</span>) and set appropriate file
            permissions, especially if you chose to store the key
            in an unencrypted format.</p>
          </li>
        </ol>

        <p><b>If you have a pre-existing RSA key/certificate
        combination that you use with Apache and would like to
        import it into a java keystore:</b></p>

        <ol type="1">
          <li>
            <p>Convert the private key to unencrypted DER-encoded
            pkcs8 format. Assuming your PEM-encoded key is stored
            in a file named <span class="fixed">yourkey.enckey</span>, enter the
            following command.</p>

            <blockquote>
              <p><span class="fixed">$ openssl pkcs8 -in yourkey.enckey -topk8
              -nocrypt -outform DER -out yourkey.der.pkcs8</span></p>
            </blockquote>
          </li>

          <li>
            <p>Create a certificate bundle file. This file should
            include a series of PEM-encoded X509 certificates
            representing a complete trust chain, from the root CA
            certificate to the certificate that matches your
            private key. If your certificate is stored in a file
            named <span class="fixed">mycert</span> and the CA signer certificate is
            stored in a file named <span class="fixed">ca.cert</span>, you might
            enter the following command to create the bundle.</p>

            <blockquote>
              <p><span class="fixed">$ cat mycert ca.cert &gt; cert.bundle</span></p>
            </blockquote>

            <b>Note: <span class="fixed">mod_ssl</span>-enabled Apache
            installations include a number of commonly recognized
            CA certificates in the <span class="fixed">ca-bundle.crt</span> file
            under the <span class="fixed">$ServerRoot/conf/ssl.crt/</span>
            directory.</b>
          </li>

          <li>
            <p>Import the key and certificate into the keystore.
            Assuming you have already created a keystore named
            <span class="fixed">yourstore</span> with a password of of
            <span class="fixed">yourpass</span>, enter the following command to store
            the data under the alias <span class="fixed">youralias</span>.</p>

            <blockquote>
              <p><span class="fixed">$ ./extkeytool -importkey -keystore yourstore
              -alias youralias -storepass yourpass -keyfile
              yourkey.der.pkcs8 -certfile cert.bundle -provider
              org.bouncycastle.jce.provider.BouncyCastleProvider</span></p>
            </blockquote>
          </li>

          <li>
            <p>You can verify that the import was successful by
            listing entry. Use the command below.</p>

            <blockquote>
              <p><span class="fixed">$ keytool -list -v -keystore yourstore -alias
              youralias</span></p>
            </blockquote>
          </li>

          <li>
            <p>Remember to delete <span class="fixed">yourkey.der.pkcs8</span>, as it
            contains your unencrypted private key.</p>
          </li>
        </ol>

        <p><b>If you are starting from scratch and do not yet have
        a certificate/key pair:</b></p>

        <ol type="1">
          <li>
            <p>Generate an RSA private key. Use the command below,
            substituting <span class="fixed">yourkey</span> with an appropriate name
            to use to refer to the key.</p>

            <blockquote>
              <p><span class="fixed">$ openssl genrsa -des3 -out yourkey.enckey
              1024</span></p>
            </blockquote>
          </li>

          <li>
            <p>The following command generates a Certificate
            Signing Request, which should be communicated to a
            Certificate Authority.</p>

            <blockquote>
              <p><span class="fixed">$ openssl req -new -key
              yourkey.enckey</span></p>
            </blockquote>
          </li>

          <li>
            <p>The Certificate Authority should respond with a
            PEM-encoded X509 certificate. Set the <span class="fixed">mod_ssl</span>
            <span class="fixed">SSLCertificateKeyFile</span> directive to point to
            the key file you just created and the
            <span class="fixed">SSLCertificateFile</span> directive to point to file
            containing the certificate issued by the Certificate
            Authority. Previous sections explaion how to share the
            key/certificate pair with a Java keystore.</p>
          </li>
        </ol>
      </blockquote>
    </blockquote>

    <br>
    <h4><a name="5.c."></a>5.c. The Attribute Resolver</h4>

    <blockquote>
      <p>Shibboleth provides a powerful attribute resolver that allows
      origins to quickly configure the retrieval of simple attributes
      from standard types of attribute stores.  The resolver is configured
      using an xml file wich should be pointed to with the <span
      class="fixed">edu.internet2.middleware.shibboleth.aa.
      attrresolv.AttributeResolver.ResolverConfig</span> propety in <span
      class="fixed">origin.properties</span> as described in
      section <a href="#4.a.">4.a</a>.  For more complex attributes or
      those that require processing before release, customized Java
      classes will need to be written.  For more information,
      consult the programmer's guide.</p>

      <p>The resolver is essentially a directed graph from attribute
      definitions to data connectors. The data connectors pull data, in
      the form of attributes, from external data sources.  The attribute
      definitions then process this data into a from suitable for use
      by Shibboleth.  This procedure can be as simple as taking an
      unmodified string value from a data connector and tagging it with
      a name or can include arbitrarily complex business rules.</p>

      <p>The <span class="fixed">resolver.xml</span> file that is
      pointed to by <span class="fixed">origin.properties</span>
      consists of zero or more attribute definitions followed by zero or
      more data connectors.  Each attribute definition consists of an
	  identifier corresponding to the URN of the attribute, and optional 
	  references to data connectors on which it depends.  Each data connector
      consists of a string identifier which is used by attribute
      definitions that refer to it, and one or more elements specific to
      the configuration of that data connector.</p>

      <p>Shibboleth comes with two attribute definitions provided in
      version 1.0: the <span
      class="fixed">SimpleAttributeDefinition</span>, which acts as
      a basic proxy for attributes supplied by data connectors with some
      name conversion and attribute scoping added, and a <span
      class="fixed">CustomAttributeDefinition</span>, which can be
      used to configure user-created attribute definition plugins.
      Similarly, Shibboleth 1.0 comes with two data connectors: the
      <span class="fixed">JNDIDirectoryDataConnector</span>, which
      pulls data from any source for which there is a JNDI Directory
      Context implementation, including LDAP, NDS, etc., and the <span
      class="fixed">CustomDataConnector</span>, which is used to
      configure user-created data connector plugins.</p>

      <p>A detailed explanation of each configuration option for the
      provided connectors follows:</p>
      
      <p><span class="fixed">JNDIDirectoryDataConnector</span>:</p>

      <dl>
        <dd class="attribute">
          <span class="fixed">id = &lt;string&gt;</span>
        </dd>

        <dd class="value">
          <p>Specifies a unique, textual name for the connector used by
          attribute definitions to refer to and use it to build
          attributes.  Contained within the <span
          class="fixed">JNDIDirectoryDataConnector</span>
          element.</p>
        </dd>

        <dd class="attribute">
          <span class="fixed">&lt;Property name=&quot;&lt;name&gt;&quot; value=&quot;&lt;value&gt;&quot;/&gt;</span>
        </dd>

        <dd class="value">
          <p>An element of the element <span
          class="fixed">JNDIDirectoryDataConnector</span>. 
          Specifies a set of name/value pairs that are used to configure
          the JNDI Directory Context.  This list of name/value pairs is
          defined by the context itself, but is specified within <span
          class="fixed">resolver.xml</span>.  Refer to the <a
          href="http://http://marsalis.internet2.edu/cgi-bin/viewcvs.cgi
          /shibboleth/java/src/conf/resolver.ldap.xml">Shibboleth
          CVS</a> for an example of names and values used to connect to
          an LDAP directory.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;Search&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">JNDIDirectoryDataConnector</span>.  This
          element defines the DN filter used to perform the LDAP search.
           The search string must return no more than one result.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;Controls&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">Search</span>.  This
          element grants some fine-grained control over the LDAP API
          calls.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;cacheTime &quot;&lt;seconds&gt;&quot;/&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">JNDIDirectoryDataConnector</span>. 
          Specifies an optional duration in <span
          class="fixed">seconds</span> for which the attribute
          resolver may cache information retrieved from this
          connector.</p>
        </dd>
      </dl>

      <p>A representation of a properly constructed <span
      class="fixed">JNDIDirectoryDataConnector</span> element would
      look like:</p>

      <blockquote><span class="fixed">
        &lt;JNDIDirectoryDataConnector id=&quot;directory&quot;&gt;<br>
          &nbsp;&nbsp;&lt;Search filter=&quot;cn=%PRINCIPAL%&quot;&gt;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&lt;Controls searchScope=&quot;SUBTREE_SCOPE&quot; returningObjects=&quot;false&quot; /&gt;<br>
          &nbsp;&nbsp;&lt;/Search&gt;<br>
          &nbsp;&nbsp;&lt;Property name=&quot;java.naming.factory.initial&quot; value=&quot;com.sun.jndi.ldap.LdapCtxFactory&quot; /&gt;<br>
          &nbsp;&nbsp;&lt;cacheTime=&quot;2400&quot;/&gt;<br>
        &lt;/JNDIDirectoryDataConnector&gt;
      </span></blockquote>

      <p><span class="fixed">SimpleAttributeDefinition</span>:</p>

      <dl>
        <dd class="attribute">
          <span class="fixed">id = &lt;string&gt;</span>
        </dd>

        <dd class="value">
          <p>Specifies a unique, textual name for the attribute which is
          used as the attribute's name when it is sent over the wire by
          Shibboleth.  Contained within the <span
          class="fixed">SimpleAttributeDefinition</span>
          element.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;AttributeDependency / DataConnectorDependency requires=&quot;&lt;id&gt;&quot;/&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">SimpleAttributeDefinition</span>, which may
          contain 0 or more of either <span
          class="fixed">AttributeDependency</span> or <span
          class="fixed">DataConnectorDependency</span>.  These
          specify attributes and data connectors that can be utilized by
          this attribute definition.  Each of these elements must
          contain a <span class="fixed">requires</span> statement
          which this attribute definition can then use to build its
          value.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">smartScope = &quot;&lt;domain&gt;&quot;</span>
        </dd>

        <dd class="valueopt">
          <p>Specifes a domain scope to be attached to the attribute. If
          the value of the attribute as retrieved from the data
          connector includes a pre-existing scope (<span
          class="fixed">bob@foo.edu</span>), that scope is used
          instead.  Contained within the <span
          class="fixed">SimpleAttributeDefinition</span>
          element.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">sourceName = &quot;&lt;string&gt;&quot;</span>
        </dd>

        <dd class="valueopt">
          <p>Specifies a different source attribute name to be used in
          calls to the data connector, while the name on the wire will
          be the specified <span class="fixed">id</span>.  This
          would be useful to send a local UniversityID attribute as
          eduPersonPrincipalName.  If not supplied, the connector
          tokenizes the <span class="fixed">id</span> field and
          uses the section following the <span
          class="fixed">#</span> to query data connectors. 
          Contained within the <span
          class="fixed">SimpleAttributeDefinition</span>
          element.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;cacheTime &quot;&lt;seconds&gt;&quot;/&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">SimpleAttributeDefinition</span>. 
          Specifies an optional duration in <span
          class="fixed">seconds</span> for which the attribute
          resolver may cache this attribute for use in additional
          assertions.</p>
        </dd>

        <dd class="attributeopt">
          <span class="fixed">&lt;lifeTime &quot;&lt;seconds&gt;&quot;/&gt;</span>
        </dd>

        <dd class="valueopt">
          <p>An element of the element <span
          class="fixed">SimpleAttributeDefinition</span>. 
          Specifies in the attribute assertion how long the attribute
          should be cached and retained by the target upon receipt. 
          Federations and trust agreements may have some bearing on the
          population and use of this field.</p>
        </dd>
      </dl>

      <p>A representation of a properly constructed <span
      class="fixed">SimpleAttributeDefinition</span> element would
      look like:</p>

      <blockquote><span class="fixed">
        &lt;SimpleAttributeDefinition id=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot; smartScope=&quot;shibdev.edu&quot; sourceName=&quot;universityPerson&quot;&gt;<br>
          &nbsp;&nbsp;&lt;DataConnectorDependency requires=&quot;dataConnector&quot;/&gt;<br>
          &nbsp;&nbsp;&lt;AttributeDependency requires=&quot;urn:mace:dir:attribute-def:eduPersonScopedAffiliation&quot;/&gt;<br>
	      &nbsp;&nbsp;&lt;cacheTime=&quot;600&quot;/&gt;&lt;br&gt;<br>
	      &nbsp;&nbsp;&lt;lifeTime=&quot;3600&quot;/&gt;&lt;br&gt;<br>
	    &lt;/SimpleAttributeDefinition&gt;
      </span></blockquote>

      <p>A properly formed <span class="fixed">resolver.xml</span>
      file to automatically generate a simple response for EPPN may take
      the form:</p>

      <blockquote><span class="fixed">
         &lt;AttributeResolver xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;urn:mace:shibboleth:resolver:1.0&quot; xsi:schemaLocation=&quot;urn:mace:shibboleth:resolver:1.0 shibboleth-resolver-1.0.xsd&quot;&gt;<br>
	     <br>
	     &nbsp;&nbsp;&lt;SimpleAttributeDefinition id=&quot;urn:mace:dir:attribute-def:eduPersonPrincipalName&quot; smartScope=&quot;shibdev.edu&quot;&gt;<br>
		    &nbsp;&nbsp;&nbsp;&nbsp;&lt;DataConnectorDependency requires=&quot;echo&quot;/&gt;<br>
	      &nbsp;&nbsp;&lt;/SimpleAttributeDefinition&gt;<br>
	     <br>
        &nbsp;&nbsp;&lt;CustomDataConnector id=&quot;echo&quot;
		class=&quot;edu.internet2.middleware.shibboleth.aa.attrresolv.provider.SampleConnector&quot; /&gt;<br>
        &lt;/AttributeResolver&gt;
      </span></blockquote>
      
      <p>There are additional examples of <span class="fixed">resolver.xml</span> files provided in the <a href="http://marsalis.internet2.edu/cgi-bin/viewcvs.cgi/shibboleth/java/src/conf/">Shibboleth CVS</a>.</p>

    </blockquote>
    <br>
    <h4><a name="5.d."></a>5.d. Local Error Page</h4>
    <blockquote>
		<p>Origin sites are encouraged to provide federations with the 
		URL of a local Shibboleth error page. If a browser user from the 
		origin site encounters a problem at a shibbolized target, the target 
		is likely to display an error page that includes a link back to this 
		origin provided page.</p>

		<p>The page should provide information on how to obtain local support 
		for using Shibbolized resources. It might also include suggestions on 
		what information should be recorded before beginning the problem 
		resolution process.</p> 
    </blockquote>

    <br>
    <br>
    <hr>
    <br>
     

    <h3><a name="6."></a>6. Troubleshooting</h3>

    <p>This section provides basic information about testing,
    logging, and error handling for Shibboleth origins. This
    information is not intended to be comprehensive, but instead
    rudimentary guidelines for basic configuration tests and
    problems. For more detailed information or answers to specific
    problems not addressed in this section, please mail <a href=
    "mailto:mace-shib-users@internet2.edu">mace-shib-users@internet2.edu</a>
    with a thorough description of errors and configurations
    used.</p>

    <h4><a name="6.a."></a>6.a. Basic Testing</h4>

    <blockquote>
      <p>Internet2 provides a basic target that can be used to test
      origin setup functionality. After your origin is recognized
      by InQueue, simply use any browser to access <a href=
      "https://wayf.internet2.edu/InQueue/sample.jsp">https://wayf.internet2.edu/InQueue/sample.jsp</a>.
      Select your origin's name and follow the login process as a
      user would. Note that SSL must be used, and both the HS and
      AA must be fully configured.</p>

      <p>The test target will then display a simple page which
      includes the basic information sent to it by your origin and
      the authentication rules it is using.</p>

      <p><b>For information regarding specific error messages that
      may be generated if the origin does not work successfully,
      please refer to section <a href="#6.c.">6.c</a>.</b></p>
    </blockquote>

    <h4><a name="6.b."></a>6.b. Logging</h4>

    <blockquote>
      <p>Shibboleth's origin components log various operations
      which may prove useful for auditing, testing, and security
      purposes. This data is sent through <span class="fixed">log4j</span>'s
      standard mechanism. The location of
      the log file, the level at which the log is output, the
      formatting of the logs, and many more options may be
      configured by editing
      <span class="fixed">/WEB-INF/classes/conf/log4j.properties</span>. By default,
      it is setup to log to the console of the servlet container, with a
      level of <span class="fixed">WARN</span>, but there is also a commented out
      example in the file to give a possible alternate configuration.</p>
    </blockquote>

    <h4><a name="6.c."></a>6.c. Common Problems</h4>

    <blockquote>
      <p>A knowledge base is being developed in the <a
		  href="http://www.columbia.edu/~wassa/shib.faq/shibboleth-faq.html">
		  Shibboleth Deployer's FAQ</a>.  Please mail <a href=
      "mailto:mace-shib-users@internet2.edu">mace-shib-users@
      internet2.edu</a> with any additional questions or problems
      encountered that are not answered by this basic guide.</p>
    </blockquote>
  </body>
</html>

